# Design Document: Snapshot Testing Utility for JUnit XML Files

## Overview

This document outlines the design for a snapshot testing utility written in Rust that will track changes to test results over time. The utility will specifically process JUnit XML files generated by pytest while testing C code and will follow a workflow pattern similar to the `insta` crate.

## Goals

- Create a Rust-based utility that can parse and process JUnit XML files
- Track changes in test results over time using snapshots
- Provide a workflow similar to `insta` for reviewing and accepting changes
- Support integration with CI/CD pipelines
- Make it easy to identify regressions or improvements in C code tests

## Background

### JUnit XML Format

JUnit XML is a standard format for test results that includes:
- Test suite information
- Individual test case results
- Execution time
- Error and failure information
- System output

### Insta Workflow

The `insta` crate provides a workflow that is the inspiration for this tool.

#### Baseline workflow

1. Integration tests succeed locally
2. Run the `capture` command locally to create a snapshot file from the XML, named baseline
3. Check in and PR the baseline snapshots

#### PR Failure workflow

1. Tests generate a JUnit report
2. The report is then compared with the stored baseline snapshot (in the PR, not main)
3. In CI, an error is raised if there are any differences 
4. Interactively, users can review and accept the changes using a CLI tool
5. Snapshot updates are then added to the PR 

The workflow for adding new ciphers, curves, and other fixtures should be identical to the PR failure workflow.  

For entirely new tests, we need to ensure that the delta check routine fails if no baseline snapshot file exists for a given JUnit report.

### Phase 1: Core Functionality

1. **JUnit XML Parser**
   - Implement parser using `quick-xml` or similar crate
   - Create data structures for test suites and cases
   - Add validation for XML format

2. **Snapshot Storage**
   - Design snapshot file format in Toml
   - Must be plain text that could be searched with `grep`
   - Create directory structure for snapshots

3. **Basic Comparison Logic**
   - Implement algorithms to compare test results
   - Generate detailed diffs between snapshots
   - Highlight important changes (e.g., passing â†’ failing)
   - Generate an error code when differences are detected
   - On failures in CI, provide a narrative description of what failed and how to fix
   - For large changes (>10), summarize trends, patterns or aggregate results

### Phase 2: CLI Interface

1. **Command Structure**
   - `init`: Initialize snapshot directory
   - `capture`: Create new snapshots from JUnit XML files
   - `compare`: Compare current results with snapshots
   - `accept`: Accept all changes to snapshots

2. **Output Formatting**
   - Color-coded terminal output
   - Summary statistics
   - Detailed test case information

3. **Filtering Options**
   - Filter by test name/pattern
   - Filter by status change
   - Filter by test suite

## Example Usage

```bash
# Initialize snapshot directory
snapshot-tool init

# Capture snapshots from JUnit XML files
snapshot-tool capture --input test-results/*.xml

# Check current results against snapshots
snapshot-tool check --input test-results/*.xml

# Accept all changes
snapshot-tool accept
```

## Testing Strategy

1. **Unit Tests**
   - Test XML parsing with various JUnit formats
   - Test snapshot comparison logic
   - Test CLI argument parsing

2. **Integration Tests**
   - End-to-end workflow tests
   - Test with real JUnit XML files

3. **Property-Based Tests**
   - Generate random test suites and verify comparison logic

## Future Enhancements

1. **Performance Metrics**
   - Track test execution time trends
   - Identify slow tests

2. **Multi-Project Support**
   - Compare results across multiple projects
   - Aggregate statistics

3. **Plugin System**
   - Custom formatters
   - Integration with other testing frameworks

4. **Web Interface**
   - Browser-based review of changes
   - Dashboard for test trends

## Conclusion

This snapshot testing utility will provide a robust way to track changes in C code test results over time. By following the workflow pattern of the `insta` crate and focusing on JUnit XML files, it will offer a familiar and efficient experience for developers while helping to identify regressions quickly.
